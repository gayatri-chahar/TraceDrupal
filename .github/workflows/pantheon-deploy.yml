name: Deploy to Pantheon

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # --------------------------
    # 1. Checkout Repository
    # --------------------------
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -----------------------------------
    # 2. Validate Secrets (Fixed for multi-line secrets)
    # -----------------------------------
    - name: Validate GitHub Secrets
      shell: bash
      run: |
        if [[ -z "$PANTHEON_SSH_KEY" ]]; then echo "❌ Missing PANTHEON_SSH_KEY"; exit 1; fi
        if [[ -z "$PANTHEON_MACHINE_TOKEN" ]]; then echo "❌ Missing PANTHEON_MACHINE_TOKEN"; exit 1; fi
        if [[ -z "$PANTHEON_SITE_NAME" ]]; then echo "❌ Missing PANTHEON_SITE_NAME"; exit 1; fi
      env:
        PANTHEON_SSH_KEY: ${{ secrets.PANTHEON_SSH_KEY }}
        PANTHEON_MACHINE_TOKEN: ${{ secrets.PANTHEON_MACHINE_TOKEN }}
        PANTHEON_SITE_NAME: ${{ secrets.PANTHEON_SITE_NAME }}

    # ---------------------
    # 3. Setup SSH
    # ---------------------
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${PANTHEON_SSH_KEY}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 2222 codeserver.dev.${PANTHEON_SITE_NAME}.drush.in >> ~/.ssh/known_hosts
      env:
        PANTHEON_SSH_KEY: ${{ secrets.PANTHEON_SSH_KEY }}
        PANTHEON_SITE_NAME: ${{ secrets.PANTHEON_SITE_NAME }}

    # ---------------------
    # 4. Set up PHP & Composer
    # ---------------------
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, intl, gd, pdo_mysql
        tools: composer

    # ---------------------
    # 5. Composer Install (with Cache)
    # ---------------------
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: vendor
        key: composer-${{ hashFiles('composer.lock') }}

    - name: Install Composer depe
