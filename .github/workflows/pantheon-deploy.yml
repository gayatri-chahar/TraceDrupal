name: Deploy to Pantheon

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate secrets
      run: |
        if [[ -z "$PANTHEON_MACHINE_TOKEN" ]]; then echo "❌ Missing PANTHEON_MACHINE_TOKEN"; exit 1; fi
        if [[ -z "$PANTHEON_SITE_NAME" ]]; then echo "❌ Missing PANTHEON_SITE_NAME"; exit 1; fi
      env:
        PANTHEON_MACHINE_TOKEN: ${{ secrets.PANTHEON_MACHINE_TOKEN }}
        PANTHEON_SITE_NAME: ${{ secrets.PANTHEON_SITE_NAME }}

    # Install PHP & Composer
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader

    # NodeJS for theme
    - name: Setup NodeJS
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Build theme assets
      run: |
        if [ -d "web/themes/custom" ]; then
          for theme in web/themes/custom/*; do
            if [ -f "$theme/package.json" ]; then
              cd "$theme"
              npm install
              npm run build || true
              cd -
            fi
          done
        fi

    # Deploy using Pantheon GitHub Action
    - name: Deploy to Pantheon
      uses: pantheon-systems/terminus-github-actions@v1
      with:
        pantheon-machine-token: ${{ secrets.PANTHEON_MACHINE_TOKEN }}
        site: ${{ secrets.PANTHEON_SITE_NAME }}
        env: dev
        build: true   # run composer & node builds
        deploy: true  # push code & apply updates

    # Run Drush commands via Terminus API (no SSH needed)
    - name: Run Drush Commands
      run: |
        terminus drush $PANTHEON_SITE_NAME.dev -- cim -y
        terminus drush $PANTHEON_SITE_NAME.dev -- updb -y
        terminus drush $PANTHEON_SITE_NAME.dev -- cr
      env:
        PANTHEON_SITE_NAME: ${{ secrets.PANTHEON_SITE_NAME }}
        TERMINUS_MACHINE_TOKEN: ${{ secrets.PANTHEON_MACHINE_TOKEN }}
